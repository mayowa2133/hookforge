generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectStatus {
  DRAFT
  READY
  RENDERING
  DONE
  ERROR
}

enum AssetKind {
  VIDEO
  IMAGE
  AUDIO
}

enum RenderJobStatus {
  QUEUED
  RUNNING
  DONE
  ERROR
}

enum WorkspaceRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum PlanStatus {
  ACTIVE
  PAUSED
  CANCELED
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum CreditEntryType {
  CREDIT
  DEBIT
  ADJUSTMENT
  REFUND
}

enum MediaSource {
  UPLOAD
  URL_IMPORT
  GENERATED
}

enum MediaArtifactKind {
  ORIGINAL
  NORMALIZED
  PREVIEW
  THUMBNAIL
  TRANSCRIPT
  CAPTIONS
  DUBBED
  LIPSYNC
  OUTPUT
}

enum SourceLinkType {
  WEBSITE
  YOUTUBE
  REDDIT
  OTHER
}

enum TimelineTrackKind {
  VIDEO
  AUDIO
  CAPTION
  EFFECT
}

enum ClipType {
  MEDIA
  COLOR
  GENERATOR
  TEXT
}

enum AIJobType {
  INGEST_URL
  TRANSCRIBE
  CAPTION_TRANSLATE
  AI_EDIT
  CHAT_EDIT
  AI_CREATOR
  AI_ADS
  AI_SHORTS
  DUBBING
  LIPSYNC
  EYE_CONTACT
  DENOISE
}

enum AIJobStatus {
  QUEUED
  RUNNING
  DONE
  ERROR
  CANCELED
}

enum ConsentStatus {
  PENDING
  VERIFIED
  REJECTED
  REVOKED
}

enum TrustEventType {
  RIGHTS_ATTESTED
  CONSENT_SUBMITTED
  CONSENT_VERIFIED
  CONTENT_FLAGGED
  CONTENT_TAKEDOWN
  POLICY_VIOLATION
}

enum TrustSeverity {
  INFO
  WARN
  HIGH
  CRITICAL
}

enum ApiKeyStatus {
  ACTIVE
  DISABLED
}

enum ModelVersionStatus {
  CANDIDATE
  ACTIVE
  DEPRECATED
  ROLLED_BACK
}

enum EvalRunStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
}

enum UsageAnomalySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum UsageAnomalyStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
}

enum IdentityProviderType {
  OIDC
  SAML
}

enum SsoSessionStatus {
  INITIATED
  COMPLETED
  EXPIRED
  FAILED
}

enum AudioEnhancementPreset {
  CLEAN_VOICE
  DIALOGUE_ENHANCE
  BROADCAST_LOUDNESS
  CUSTOM
}

enum AudioEnhancementMode {
  PREVIEW
  APPLY
}

enum AudioEnhancementOperation {
  ENHANCE
  FILLER_REMOVE
}

enum AudioEnhancementRunStatus {
  PREVIEWED
  APPLIED
  ERROR
}

enum FillerCandidateStatus {
  DETECTED
  PREVIEWED
  APPLIED
  SKIPPED
}

enum ShareLinkScope {
  VIEW
  COMMENT
  APPROVE
}

enum ReviewCommentStatus {
  OPEN
  RESOLVED
}

enum ReviewDecisionStatus {
  APPROVED
  REJECTED
}

model User {
  id                 String                @id @default(cuid())
  email              String                @unique
  passwordHash       String
  createdAt          DateTime              @default(now())
  projects           Project[]
  workspacesOwned    Workspace[]           @relation("WorkspaceOwner")
  workspaceMembers   WorkspaceMember[]
  projectV2Created   ProjectV2[]           @relation("ProjectV2Creator")
  timelineCreated    TimelineRevision[]    @relation("TimelineRevisionCreator")
  rightsAttestations RightsAttestation[]
  consentReviewed    ConsentVerification[] @relation("ConsentReviewer")
  trustEvents        TrustEvent[]
  sourceImports      IngestionSourceLink[]
  apiKeysCreated     PublicApiKey[]        @relation("ApiKeyCreator")
  routePoliciesUpdated RoutingPolicy[]     @relation("RoutingPolicyUpdatedBy")
  qualityEvalRunsCreated QualityEvalRun[]  @relation("QualityEvalCreatedBy")
  qualityFeedbackCreated QualityFeedback[] @relation("QualityFeedbackCreatedBy")
  usageAnomaliesResolved UsageAnomaly[]    @relation("UsageAnomalyResolvedBy")
  userIdentities     UserIdentity[]
  ssoSessions        SsoSession[]          @relation("SsoSessionUser")
  securityPoliciesUpdated WorkspaceSecurityPolicy[] @relation("WorkspaceSecurityPolicyUpdatedBy")
  auditEventsActed   AuditEvent[]          @relation("AuditEventActor")
  identityProvidersCreated IdentityProviderConfig[] @relation("IdentityProviderConfigCreatedBy")
  incidentsResolved  SystemIncident[]      @relation("SystemIncidentResolvedBy")
  audioEnhancementRunsCreated AudioEnhancementRun[] @relation("AudioEnhancementRunCreatedBy")
  shareLinksCreated  ShareLink[]           @relation("ShareLinkCreatedBy")
  reviewCommentsAuthored ReviewComment[]   @relation("ReviewCommentAuthor")
  reviewCommentsResolved ReviewComment[]   @relation("ReviewCommentResolvedBy")
  reviewDecisions    ReviewDecision[]      @relation("ReviewDecisionDecider")
  exportProfilesCreated ExportProfile[]    @relation("ExportProfileCreatedBy")
}

model Workspace {
  id                  String                @id @default(cuid())
  name                String
  slug                String                @unique
  ownerId             String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  owner               User                  @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members             WorkspaceMember[]
  projectsLegacy      Project[]             @relation("WorkspaceLegacyProjects")
  projectsV2          ProjectV2[]
  plans               Plan[]
  subscriptions       Subscription[]
  creditWallet        CreditWallet?
  creditLedgerEntries CreditLedgerEntry[]
  captionStylePresets CaptionStylePreset[]
  mediaAssets         MediaAsset[]
  aiJobs              AIJob[]
  voiceProfiles       VoiceProfile[]
  voiceClones         VoiceClone[]
  avatarProfiles      AvatarProfile[]
  aiTwins             AITwin[]
  rightsAttestations  RightsAttestation[]
  consentVerifications ConsentVerification[]
  trustEvents         TrustEvent[]
  publicApiKeys       PublicApiKey[]
  qualityFeedback     QualityFeedback[]
  usageAnomalies      UsageAnomaly[]
  translationProfiles TranslationProfile[]
  securityPolicy      WorkspaceSecurityPolicy?
  identityProviders   IdentityProviderConfig[]
  userIdentities      UserIdentity[]
  auditEvents         AuditEvent[]
  ssoSessions         SsoSession[]
  systemIncidents     SystemIncident[]
  audioEnhancementRuns AudioEnhancementRun[]
  fillerCandidates    FillerCandidate[]
  shareLinks          ShareLink[]
  reviewComments      ReviewComment[]
  reviewDecisions     ReviewDecision[]
  exportProfiles      ExportProfile[]

  @@index([ownerId])
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(EDITOR)
  createdAt   DateTime      @default(now())

  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Template {
  id          String    @id @default(cuid())
  slug        String    @unique
  name        String
  description String
  tags        String[]
  slotSchema  Json
  createdAt   DateTime  @default(now())
  projects    Project[]
}

model Project {
  id          String        @id @default(cuid())
  userId      String
  templateId  String
  workspaceId String?
  title       String
  status      ProjectStatus @default(DRAFT)
  config      Json
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  template    Template      @relation(fields: [templateId], references: [id], onDelete: Restrict)
  workspace   Workspace?    @relation("WorkspaceLegacyProjects", fields: [workspaceId], references: [id], onDelete: SetNull)
  assets      Asset[]
  renderJobs  RenderJob[]

  @@index([userId])
  @@index([templateId])
  @@index([workspaceId])
}

model Asset {
  id          String    @id @default(cuid())
  projectId   String
  slotKey     String
  kind        AssetKind
  storageKey  String
  mimeType    String
  durationSec Float?
  width       Int?
  height      Int?
  createdAt   DateTime  @default(now())

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@unique([projectId, slotKey])
}

model RenderJob {
  id               String          @id @default(cuid())
  projectId        String
  status           RenderJobStatus @default(QUEUED)
  progress         Int             @default(0)
  outputStorageKey String?
  errorMessage     String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  project          Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Plan {
  id             String      @id @default(cuid())
  workspaceId    String
  name           String
  tier           String
  monthlyCredits Int
  trialDays      Int?
  status         PlanStatus  @default(ACTIVE)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  workspace      Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  subscriptions  Subscription[]

  @@index([workspaceId])
}

model Subscription {
  id                 String             @id @default(cuid())
  workspaceId        String
  planId             String?
  provider           String
  externalReference  String?
  status             SubscriptionStatus @default(TRIALING)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  workspace          Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  plan               Plan?              @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([planId])
}

model CreditWallet {
  id          String              @id @default(cuid())
  workspaceId String              @unique
  balance     Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  workspace   Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  entries     CreditLedgerEntry[]
}

model CreditLedgerEntry {
  id            String          @id @default(cuid())
  walletId      String
  workspaceId   String
  feature       String
  entryType     CreditEntryType
  amount        Int
  referenceType String?
  referenceId   String?
  metadata      Json?
  createdAt     DateTime        @default(now())

  wallet        CreditWallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([workspaceId, createdAt])
}

model ProjectV2 {
  id               String             @id @default(cuid())
  workspaceId      String
  legacyProjectId  String?            @unique
  createdByUserId  String?
  title            String
  status           ProjectStatus      @default(DRAFT)
  currentRevisionId String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  workspace        Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy        User?              @relation("ProjectV2Creator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  currentRevision  TimelineRevision?  @relation("CurrentRevision", fields: [currentRevisionId], references: [id], onDelete: SetNull)
  revisions        TimelineRevision[] @relation("ProjectRevisions")
  tracks           TimelineTrack[]
  mediaAssets      MediaAsset[]
  transcriptWords  TranscriptWord[]
  transcriptSegments TranscriptSegment[]
  captionSegments  CaptionSegment[]
  aiJobs           AIJob[]
  qualityFeedback  QualityFeedback[]
  audioEnhancementRuns AudioEnhancementRun[]
  fillerCandidates FillerCandidate[]
  shareLinks       ShareLink[]
  reviewComments   ReviewComment[]
  reviewDecisions  ReviewDecision[]

  @@index([workspaceId])
  @@index([createdByUserId])
}

model TimelineRevision {
  id                String          @id @default(cuid())
  projectId         String
  revisionNumber    Int
  operations        Json
  timelineHash      String
  createdByUserId   String?
  createdAt         DateTime        @default(now())

  project           ProjectV2       @relation("ProjectRevisions", fields: [projectId], references: [id], onDelete: Cascade)
  currentForProject ProjectV2[]     @relation("CurrentRevision")
  createdBy         User?           @relation("TimelineRevisionCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  tracks            TimelineTrack[]
  audioEnhancementRuns AudioEnhancementRun[]
  reviewDecisions   ReviewDecision[]

  @@unique([projectId, revisionNumber])
  @@index([projectId])
}

model TimelineTrack {
  id          String            @id @default(cuid())
  projectId   String
  revisionId  String?
  kind        TimelineTrackKind
  name        String
  sortOrder   Int
  volumeDb    Float?
  isMuted     Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  project     ProjectV2         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  revision    TimelineRevision? @relation(fields: [revisionId], references: [id], onDelete: SetNull)
  clips       Clip[]
  captionSegments CaptionSegment[]

  @@index([projectId])
  @@index([revisionId])
}

model Clip {
  id           String      @id @default(cuid())
  trackId      String
  clipType     ClipType    @default(MEDIA)
  mediaAssetId String?
  label        String?
  timelineInMs Int
  timelineOutMs Int
  sourceInMs   Int
  sourceOutMs  Int
  transform    Json?
  audio        Json?
  createdAt    DateTime    @default(now())

  track        TimelineTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)
  mediaAsset   MediaAsset?   @relation(fields: [mediaAssetId], references: [id], onDelete: SetNull)
  effects      Effect[]

  @@index([trackId])
  @@index([mediaAssetId])
}

model Effect {
  id          String      @id @default(cuid())
  clipId      String
  type        String
  config      Json
  createdAt   DateTime    @default(now())

  clip        Clip        @relation(fields: [clipId], references: [id], onDelete: Cascade)
  keyframes   Keyframe[]

  @@index([clipId])
}

model Keyframe {
  id          String      @id @default(cuid())
  effectId    String
  property    String
  timeMs      Int
  value       Json
  easing      String?
  createdAt   DateTime    @default(now())

  effect      Effect      @relation(fields: [effectId], references: [id], onDelete: Cascade)

  @@index([effectId])
}

model MediaAsset {
  id            String           @id @default(cuid())
  workspaceId   String
  projectId     String?
  source        MediaSource      @default(UPLOAD)
  storageKey    String
  mimeType      String
  sizeBytes     BigInt?
  durationSec   Float?
  width         Int?
  height        Int?
  sha256        String?
  createdAt     DateTime         @default(now())

  workspace     Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project       ProjectV2?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  artifacts     MediaArtifact[]
  sourceLinks   IngestionSourceLink[]
  clips         Clip[]

  @@index([workspaceId])
  @@index([projectId])
}

model MediaArtifact {
  id           String            @id @default(cuid())
  mediaAssetId String
  kind         MediaArtifactKind
  storageKey   String
  mimeType     String
  metadata     Json?
  createdAt    DateTime          @default(now())

  mediaAsset   MediaAsset        @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
}

model IngestionSourceLink {
  id              String         @id @default(cuid())
  mediaAssetId    String
  sourceType      SourceLinkType
  sourceUrl       String
  canonicalUrl    String?
  rightsAttested  Boolean        @default(false)
  importedByUserId String
  createdAt       DateTime       @default(now())

  mediaAsset      MediaAsset     @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
  importedBy      User           @relation(fields: [importedByUserId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([importedByUserId])
}

model TranscriptWord {
  id           String      @id @default(cuid())
  projectId    String
  segmentId    String?
  startMs      Int
  endMs        Int
  text         String
  speakerLabel String?
  confidence   Float?
  createdAt    DateTime    @default(now())

  project      ProjectV2   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  segment      TranscriptSegment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  fillerCandidates FillerCandidate[]

  @@index([projectId, startMs])
  @@index([segmentId])
}

model TranscriptSegment {
  id            String      @id @default(cuid())
  projectId     String
  language      String
  text          String
  startMs       Int
  endMs         Int
  speakerLabel  String?
  confidenceAvg Float?
  source        String      @default("ASR")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  project       ProjectV2   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  words         TranscriptWord[]
  fillerCandidates FillerCandidate[]

  @@index([projectId, language, startMs])
}

model AudioEnhancementRun {
  id               String                    @id @default(cuid())
  workspaceId      String
  projectId        String
  createdByUserId  String?
  timelineRevisionId String?
  mode             AudioEnhancementMode
  operation        AudioEnhancementOperation
  preset           AudioEnhancementPreset?
  status           AudioEnhancementRunStatus @default(PREVIEWED)
  config           Json
  summary          Json?
  undoToken        String?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  workspace        Workspace                 @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project          ProjectV2                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy        User?                     @relation("AudioEnhancementRunCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  timelineRevision TimelineRevision?         @relation(fields: [timelineRevisionId], references: [id], onDelete: SetNull)
  fillerCandidates FillerCandidate[]

  @@index([workspaceId, createdAt])
  @@index([projectId, createdAt])
  @@index([timelineRevisionId])
}

model FillerCandidate {
  id             String                @id @default(cuid())
  runId          String
  workspaceId    String
  projectId      String
  language       String
  segmentId      String?
  wordId         String?
  text           String
  startMs        Int
  endMs          Int
  confidence     Float?
  status         FillerCandidateStatus @default(DETECTED)
  createdAt      DateTime              @default(now())

  run            AudioEnhancementRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  workspace      Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project        ProjectV2             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  segment        TranscriptSegment?    @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  word           TranscriptWord?       @relation(fields: [wordId], references: [id], onDelete: SetNull)

  @@index([runId])
  @@index([workspaceId, createdAt])
  @@index([projectId, language, startMs])
  @@index([segmentId])
  @@index([wordId])
}

model CaptionStylePreset {
  id           String         @id @default(cuid())
  workspaceId  String
  name         String
  config       Json
  isSystem     Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  workspace    Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  captions     CaptionSegment[]
  exportProfiles ExportProfile[]

  @@index([workspaceId])
}

model ShareLink {
  id             String         @id @default(cuid())
  workspaceId    String
  projectId      String
  createdByUserId String?
  token          String         @unique
  scope          ShareLinkScope @default(VIEW)
  expiresAt      DateTime?
  revokedAt      DateTime?
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  workspace      Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project        ProjectV2      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy      User?          @relation("ShareLinkCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  reviewComments ReviewComment[]

  @@index([workspaceId, createdAt])
  @@index([projectId, scope, createdAt])
  @@index([token, revokedAt, expiresAt])
}

model ReviewComment {
  id               String              @id @default(cuid())
  workspaceId      String
  projectId        String
  authorUserId     String?
  shareLinkId      String?
  body             String
  status           ReviewCommentStatus @default(OPEN)
  anchorMs         Int?
  transcriptStartMs Int?
  transcriptEndMs  Int?
  timelineTrackId  String?
  clipId           String?
  metadata         Json?
  resolvedAt       DateTime?
  resolvedByUserId String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  workspace        Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project          ProjectV2           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author           User?               @relation("ReviewCommentAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)
  shareLink        ShareLink?          @relation(fields: [shareLinkId], references: [id], onDelete: SetNull)
  resolvedBy       User?               @relation("ReviewCommentResolvedBy", fields: [resolvedByUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([projectId, status, createdAt])
  @@index([shareLinkId])
}

model ReviewDecision {
  id               String               @id @default(cuid())
  workspaceId      String
  projectId        String
  revisionId       String?
  decidedByUserId  String?
  status           ReviewDecisionStatus
  note             String?
  metadata         Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  workspace        Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project          ProjectV2            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  revision         TimelineRevision?    @relation(fields: [revisionId], references: [id], onDelete: SetNull)
  decidedBy        User?                @relation("ReviewDecisionDecider", fields: [decidedByUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([projectId, createdAt])
  @@index([projectId, status, createdAt])
}

model ExportProfile {
  id                String    @id @default(cuid())
  workspaceId       String
  createdByUserId   String?
  name              String
  container         String    @default("mp4")
  resolution        String    @default("1080x1920")
  fps               Int       @default(30)
  videoBitrateKbps  Int?
  audioBitrateKbps  Int?
  audioPreset       String?
  captionStylePresetId String?
  isDefault         Boolean   @default(false)
  config            Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy         User?     @relation("ExportProfileCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  captionStylePreset CaptionStylePreset? @relation(fields: [captionStylePresetId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, name])
  @@index([workspaceId, isDefault])
}

model TranslationProfile {
  id             String    @id @default(cuid())
  workspaceId    String
  name           String
  sourceLanguage String
  tone           String
  glossary       Json
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  workspace      Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, name])
  @@index([workspaceId, sourceLanguage, isDefault])
}

model CaptionSegment {
  id            String             @id @default(cuid())
  projectId     String
  trackId       String?
  language      String
  text          String
  startMs       Int
  endMs         Int
  stylePresetId String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  project       ProjectV2          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  track         TimelineTrack?     @relation(fields: [trackId], references: [id], onDelete: SetNull)
  stylePreset   CaptionStylePreset? @relation(fields: [stylePresetId], references: [id], onDelete: SetNull)

  @@index([projectId, language])
  @@index([trackId])
}

model AIJob {
  id           String         @id @default(cuid())
  workspaceId  String
  projectId    String?
  type         AIJobType
  status       AIJobStatus    @default(QUEUED)
  progress     Int            @default(0)
  providerHint String?
  input        Json
  output       Json?
  errorMessage String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  workspace    Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project      ProjectV2?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  providerRuns AIProviderRun[]
  results      AIOperationResult[]
  qualityFeedback QualityFeedback[]

  @@index([workspaceId, createdAt])
  @@index([projectId])
  @@index([status])
}

model AIProviderRun {
  id          String   @id @default(cuid())
  aiJobId     String
  providerName String
  operation   String
  model       String?
  request     Json?
  response    Json?
  tokensIn    Int?
  tokensOut   Int?
  durationMs  Int?
  costUsd     Decimal? @db.Decimal(10, 4)
  createdAt   DateTime @default(now())

  aiJob       AIJob    @relation(fields: [aiJobId], references: [id], onDelete: Cascade)

  @@index([aiJobId])
}

model AIOperationResult {
  id              String   @id @default(cuid())
  aiJobId         String
  kind            String
  outputStorageKey String?
  output          Json?
  createdAt       DateTime @default(now())

  aiJob           AIJob    @relation(fields: [aiJobId], references: [id], onDelete: Cascade)

  @@index([aiJobId])
}

model VoiceProfile {
  id             String      @id @default(cuid())
  workspaceId    String
  name           String
  provider       String
  providerVoiceId String?
  language       String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  workspace      Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  voiceClones    VoiceClone[]
  aiTwins        AITwin[]

  @@index([workspaceId])
}

model VoiceClone {
  id                    String             @id @default(cuid())
  workspaceId           String
  voiceProfileId        String
  consentVerificationId String?
  status                ConsentStatus      @default(PENDING)
  sampleStorageKey      String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  workspace             Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  voiceProfile          VoiceProfile       @relation(fields: [voiceProfileId], references: [id], onDelete: Cascade)
  consentVerification   ConsentVerification? @relation(fields: [consentVerificationId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([voiceProfileId])
}

model AvatarProfile {
  id                    String             @id @default(cuid())
  workspaceId           String
  name                  String
  provider              String
  providerAvatarId      String?
  previewStorageKey     String?
  consentVerificationId String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  workspace             Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  consentVerification   ConsentVerification? @relation(fields: [consentVerificationId], references: [id], onDelete: SetNull)
  aiTwins               AITwin[]

  @@index([workspaceId])
}

model AITwin {
  id                    String             @id @default(cuid())
  workspaceId           String
  name                  String
  avatarProfileId       String?
  voiceProfileId        String?
  consentVerificationId String?
  status                ConsentStatus      @default(PENDING)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  workspace             Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  avatarProfile         AvatarProfile?     @relation(fields: [avatarProfileId], references: [id], onDelete: SetNull)
  voiceProfile          VoiceProfile?      @relation(fields: [voiceProfileId], references: [id], onDelete: SetNull)
  consentVerification   ConsentVerification? @relation(fields: [consentVerificationId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
}

model RightsAttestation {
  id          String         @id @default(cuid())
  workspaceId String
  userId      String
  sourceType  SourceLinkType
  sourceUrl   String
  statement   String
  metadata    Json?
  acceptedAt  DateTime
  createdAt   DateTime       @default(now())

  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
  @@index([userId])
}

model ConsentVerification {
  id               String         @id @default(cuid())
  workspaceId      String
  subjectType      String
  subjectName      String
  subjectEmail     String?
  status           ConsentStatus  @default(PENDING)
  evidenceStorageKey String?
  reviewedByUserId String?
  verifiedAt       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  workspace        Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  reviewedBy       User?          @relation("ConsentReviewer", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  voiceClones      VoiceClone[]
  avatarProfiles   AvatarProfile[]
  aiTwins          AITwin[]

  @@index([workspaceId, status])
}

model TrustEvent {
  id          String         @id @default(cuid())
  workspaceId String
  userId      String?
  eventType   TrustEventType
  severity    TrustSeverity  @default(INFO)
  summary     String
  metadata    Json?
  createdAt   DateTime       @default(now())

  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
}

model ModelVersion {
  id            String             @id @default(cuid())
  capability    String
  provider      String
  model         String
  version       String
  status        ModelVersionStatus @default(CANDIDATE)
  qualityScore  Float?
  latencyP95Ms  Int?
  successRate   Float?
  costPerMinUsd Decimal?           @db.Decimal(10, 4)
  releasedAt    DateTime?
  metadata      Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  activePolicies   RoutingPolicy[] @relation("RoutingPolicyActiveModel")
  fallbackPolicies RoutingPolicy[] @relation("RoutingPolicyFallbackModel")
  evalRuns         QualityEvalRun[]

  @@unique([capability, provider, model, version])
  @@index([capability, status])
}

model RoutingPolicy {
  id                   String       @id @default(cuid())
  capability           String       @unique
  activeModelVersionId String?
  fallbackModelVersionId String?
  rolloutPercent       Int          @default(100)
  maxP95LatencyMs      Int?
  minSuccessRate       Float?
  enforceQualityGate   Boolean      @default(true)
  updatedByUserId      String?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  activeModelVersion   ModelVersion? @relation("RoutingPolicyActiveModel", fields: [activeModelVersionId], references: [id], onDelete: SetNull)
  fallbackModelVersion ModelVersion? @relation("RoutingPolicyFallbackModel", fields: [fallbackModelVersionId], references: [id], onDelete: SetNull)
  updatedBy            User?         @relation("RoutingPolicyUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@index([activeModelVersionId])
  @@index([fallbackModelVersionId])
}

model QualityEvalRun {
  id              String         @id @default(cuid())
  capability      String
  modelVersionId  String?
  status          EvalRunStatus  @default(QUEUED)
  trigger         String         @default("manual")
  datasetRef      String?
  metrics         Json?
  passed          Boolean?
  summary         String?
  startedAt       DateTime?
  finishedAt      DateTime?
  createdByUserId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  modelVersion    ModelVersion?  @relation(fields: [modelVersionId], references: [id], onDelete: SetNull)
  createdBy       User?          @relation("QualityEvalCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([capability, createdAt])
  @@index([status, createdAt])
}

model QualityFeedback {
  id              String    @id @default(cuid())
  workspaceId     String
  projectId       String?
  aiJobId         String?
  category        String
  rating          Int?
  comment         String?
  metadata        Json?
  createdByUserId String?
  createdAt       DateTime  @default(now())

  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project         ProjectV2? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  aiJob           AIJob?    @relation(fields: [aiJobId], references: [id], onDelete: SetNull)
  createdBy       User?     @relation("QualityFeedbackCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([projectId])
  @@index([aiJobId])
}

model UsageAnomaly {
  id               String               @id @default(cuid())
  workspaceId      String
  feature          String
  windowStart      DateTime
  windowEnd        DateTime
  severity         UsageAnomalySeverity @default(MEDIUM)
  status           UsageAnomalyStatus   @default(OPEN)
  expectedAmount   Int?
  actualAmount     Int?
  deviationPct     Float?
  summary          String
  metadata         Json?
  resolvedAt       DateTime?
  resolvedByUserId String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  workspace        Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  resolvedBy       User?                @relation("UsageAnomalyResolvedBy", fields: [resolvedByUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, status, createdAt])
  @@index([severity, createdAt])
}

model PublicApiKey {
  id              String        @id @default(cuid())
  workspaceId     String
  createdByUserId String?
  name            String
  keyPrefix       String
  keyHash         String        @unique
  status          ApiKeyStatus  @default(ACTIVE)
  scopes          String[]      @default([])
  rateLimitPerMinute Int        @default(120)
  expiresAt       DateTime?
  rotatedFromKeyId String?
  lastRotationAt  DateTime?
  lastUsedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy       User?         @relation("ApiKeyCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  rotatedFrom     PublicApiKey? @relation("PublicApiKeyRotation", fields: [rotatedFromKeyId], references: [id], onDelete: SetNull)
  rotatedTo       PublicApiKey[] @relation("PublicApiKeyRotation")

  @@index([workspaceId])
  @@index([status, expiresAt])
}

model WorkspaceSecurityPolicy {
  id                String    @id @default(cuid())
  workspaceId       String    @unique
  enforceSso        Boolean   @default(false)
  allowPasswordAuth Boolean   @default(true)
  sessionTtlHours   Int       @default(168)
  requireMfa        Boolean   @default(false)
  allowedEmailDomains String[] @default([])
  canaryAllowlist   String[]  @default([])
  updatedByUserId   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  updatedBy         User?     @relation("WorkspaceSecurityPolicyUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
}

model IdentityProviderConfig {
  id                      String               @id @default(cuid())
  workspaceId             String
  createdByUserId         String?
  type                    IdentityProviderType
  name                    String
  issuerUrl               String?
  clientId                String?
  clientSecretCiphertext  String?
  authorizationEndpoint   String?
  tokenEndpoint           String?
  jwksUri                 String?
  samlMetadataXml         String?
  samlEntityId            String?
  samlSsoUrl              String?
  enabled                 Boolean              @default(true)
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt

  workspace               Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy               User?                @relation("IdentityProviderConfigCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  userIdentities          UserIdentity[]
  ssoSessions             SsoSession[]

  @@unique([workspaceId, name])
  @@index([workspaceId, type])
}

model UserIdentity {
  id               String               @id @default(cuid())
  workspaceId      String
  userId           String
  providerId       String
  providerType     IdentityProviderType
  providerSubject  String
  email            String?
  metadata         Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  workspace        Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider         IdentityProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, providerSubject])
  @@index([workspaceId, userId])
}

model SsoSession {
  id               String           @id @default(cuid())
  workspaceId      String
  providerId       String
  userId           String?
  state            String           @unique
  nonce            String?
  returnTo         String?
  codeVerifier     String?
  status           SsoSessionStatus @default(INITIATED)
  errorMessage     String?
  ipAddress        String?
  userAgent        String?
  createdAt        DateTime         @default(now())
  expiresAt        DateTime
  completedAt      DateTime?

  workspace        Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  provider         IdentityProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user             User?            @relation("SsoSessionUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId, status, createdAt])
  @@index([providerId])
}

model AuditEvent {
  id               String       @id @default(cuid())
  workspaceId      String
  actorUserId      String?
  action           String
  targetType       String
  targetId         String?
  severity         TrustSeverity @default(INFO)
  ipAddress        String?
  userAgent        String?
  metadata         Json?
  createdAt        DateTime     @default(now())

  workspace        Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  actor            User?        @relation("AuditEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([workspaceId, action, createdAt])
}

model SystemIncident {
  id               String       @id @default(cuid())
  workspaceId      String?
  category         String
  severity         TrustSeverity @default(WARN)
  status           String       @default("OPEN")
  summary          String
  metadata         Json?
  detectedAt       DateTime     @default(now())
  resolvedAt       DateTime?
  resolvedByUserId String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  workspace        Workspace?   @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  resolvedBy       User?        @relation("SystemIncidentResolvedBy", fields: [resolvedByUserId], references: [id], onDelete: SetNull)

  @@index([status, severity, createdAt])
  @@index([workspaceId, createdAt])
}

enum StudioRoomStatus {
  ACTIVE
  CLOSED
}

enum StudioParticipantRole {
  HOST
  GUEST
}

enum RecordingRecoveryStatus {
  OPEN
  RESOLVED
  FAILED
}

enum TranscriptIssueType {
  LOW_CONFIDENCE
  OVERLAP
  TIMING_DRIFT
}

enum AutopilotActionType {
  PLAN
  APPLY
  UNDO
}

enum AutopilotActionStatus {
  SUCCESS
  FAILED
  SUGGESTIONS_ONLY
}

enum ReviewRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PublishJobStatus {
  QUEUED
  RUNNING
  DONE
  ERROR
}

enum ParityBenchmarkStatus {
  QUEUED
  RUNNING
  DONE
  ERROR
}

model StudioRoom {
  id            String               @id @default(cuid())
  workspaceId   String
  projectId     String
  hostUserId    String?
  provider      String               @default("LIVEKIT_MANAGED")
  roomName      String
  status        StudioRoomStatus     @default(ACTIVE)
  metadata      Json?
  startedAt     DateTime?
  endedAt       DateTime?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  @@unique([projectId, roomName])
  @@index([workspaceId, createdAt])
  @@index([projectId, status, createdAt])
}

model StudioParticipant {
  id                    String                 @id @default(cuid())
  roomId                String
  workspaceId           String
  projectId             String
  userId                String?
  role                  StudioParticipantRole  @default(GUEST)
  displayName           String
  externalParticipantId String?
  trackMetadata         Json?
  joinedAt              DateTime               @default(now())
  leftAt                DateTime?
  createdAt             DateTime               @default(now())

  @@index([roomId, joinedAt])
  @@index([workspaceId, createdAt])
  @@index([projectId, joinedAt])
}

model RemoteTrackArtifact {
  id             String    @id @default(cuid())
  roomId         String
  workspaceId    String
  projectId      String
  participantId  String?
  mediaAssetId   String?
  storageKey     String?
  trackKind      String
  durationSec    Float?
  metadata       Json?
  createdAt      DateTime  @default(now())

  @@index([roomId, createdAt])
  @@index([projectId, createdAt])
}

model RecordingRecovery {
  id                 String                 @id @default(cuid())
  workspaceId        String
  projectId          String
  recordingSessionId String
  status             RecordingRecoveryStatus @default(OPEN)
  reason             String?
  metadata           Json?
  createdByUserId    String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  @@index([workspaceId, createdAt])
  @@index([projectId, recordingSessionId, createdAt])
}

model TranscriptEditCheckpoint {
  id              String    @id @default(cuid())
  workspaceId     String
  projectId       String
  language        String
  label           String
  snapshot        Json
  createdByUserId String?
  createdAt       DateTime  @default(now())

  @@index([workspaceId, createdAt])
  @@index([projectId, language, createdAt])
}

model TranscriptConflictIssue {
  id            String             @id @default(cuid())
  workspaceId   String
  projectId     String
  checkpointId  String?
  issueType     TranscriptIssueType
  severity      TrustSeverity      @default(WARN)
  message       String
  metadata      Json?
  createdAt     DateTime           @default(now())

  @@index([workspaceId, createdAt])
  @@index([projectId, issueType, createdAt])
  @@index([checkpointId])
}

model AudioPresetProfile {
  id               String    @id @default(cuid())
  workspaceId      String
  name             String
  config           Json
  isSystem         Boolean   @default(false)
  createdByUserId  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([workspaceId, name])
  @@index([workspaceId, createdAt])
}

model AudioEnhancementRunV2 {
  id                 String                  @id @default(cuid())
  workspaceId        String
  projectId          String
  sourceRunId        String?
  operation          AudioEnhancementOperation
  mode               AudioEnhancementMode
  status             AudioEnhancementRunStatus @default(PREVIEWED)
  summary            Json?
  metadata           Json?
  createdByUserId    String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  @@index([workspaceId, createdAt])
  @@index([projectId, createdAt])
}

model AutopilotSession {
  id                String               @id @default(cuid())
  workspaceId       String
  projectId         String
  prompt            String
  sourcePlanId      String?
  planRevisionHash  String
  safetyMode        String
  confidence        Float?
  status            AutopilotActionStatus @default(SUCCESS)
  metadata          Json?
  createdByUserId   String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([workspaceId, createdAt])
  @@index([projectId, createdAt])
}

model AutopilotAction {
  id               String               @id @default(cuid())
  workspaceId      String
  projectId        String
  sessionId        String
  actionType       AutopilotActionType
  status           AutopilotActionStatus @default(SUCCESS)
  payload          Json?
  errorMessage     String?
  createdAt        DateTime             @default(now())

  @@index([workspaceId, createdAt])
  @@index([projectId, createdAt])
  @@index([sessionId, createdAt])
}

model ReviewRequest {
  id               String              @id @default(cuid())
  workspaceId      String
  projectId        String
  requestedByUserId String?
  title            String
  note             String?
  requiredScopes   String[]            @default(["APPROVE"])
  status           ReviewRequestStatus @default(PENDING)
  decisionId       String?
  metadata         Json?
  decidedAt        DateTime?
  decidedByUserId  String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([workspaceId, createdAt])
  @@index([projectId, status, createdAt])
}

model ReviewDecisionLog {
  id              String               @id @default(cuid())
  workspaceId     String
  projectId       String
  requestId       String
  decidedByUserId String?
  status          ReviewDecisionStatus
  note            String?
  metadata        Json?
  createdAt       DateTime             @default(now())

  @@index([workspaceId, createdAt])
  @@index([projectId, createdAt])
  @@index([requestId, createdAt])
}

model PublishConnectorJob {
  id               String          @id @default(cuid())
  workspaceId      String
  projectId        String
  exportProfileId  String?
  connector        String
  status           PublishJobStatus @default(QUEUED)
  payload          Json?
  output           Json?
  errorMessage     String?
  createdByUserId  String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([workspaceId, createdAt])
  @@index([projectId, status, createdAt])
}

model ParityBenchmarkRun {
  id               String               @id @default(cuid())
  workspaceId      String
  status           ParityBenchmarkStatus @default(QUEUED)
  modules          String[]
  summary          Json?
  startedAt        DateTime?
  finishedAt       DateTime?
  createdByUserId  String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([workspaceId, createdAt])
  @@index([status, createdAt])
}

model ParityBenchmarkResult {
  id         String   @id @default(cuid())
  runId      String
  module     String
  score      Float
  passed     Boolean
  details    Json?
  createdAt  DateTime @default(now())

  @@index([runId, createdAt])
  @@index([module, createdAt])
}
